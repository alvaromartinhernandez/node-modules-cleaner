# Ask the user for the path to search
$basePath = Read-Host "Enter the path to search for node_modules folders (leave empty to use 'C:\', this can be slow)"

# If no path is provided, use 'C:\' by default
if ([string]::IsNullOrWhiteSpace($basePath)) {
    $basePath = "C:\"
}

# Check if the path exists
if (!(Test-Path $basePath)) {
    Write-Host "The path '$basePath' does not exist. Please check the path and try again." -ForegroundColor Red
    exit
}

# Ask if the user wants to show the log
$showLog = Read-Host "Do you want to show the details of each processed folder? (y/n)"

# Search for all folders named 'node_modules'
$nodeModules = Get-ChildItem -Path $basePath -Recurse -Directory -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -eq "node_modules" }

# If no folders are found, inform the user
if (-not $nodeModules) {
    Write-Host "No 'node_modules' folders were found in the specified path." -ForegroundColor Yellow
    exit
}

# Initialize the total size counter
$totalSize = 0

# Iterate over each folder and calculate the size
foreach ($folder in $nodeModules) {
    $size = (Get-ChildItem -Path $folder.FullName -Recurse -Force -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
    $totalSize += $size

    # Show log only if the user wants to
    if ($showLog -eq "y") {
        Write-Host "Folder: $($folder.FullName) - Size: $([math]::Round($size / 1MB, 2)) MB"
    }
}

# Show the total size of all node_modules folders
Write-Host "Total space occupied by node_modules: $([math]::Round($totalSize / 1GB, 2)) GB" -ForegroundColor Green

# Ask the user if they want to delete the folders
$delete = Read-Host "Do you want to delete all found node_modules folders? (y/n)"

if ($delete -eq "y") {
    # Delete all node_modules folders
    foreach ($folder in $nodeModules) {
        Remove-Item -Path $folder.FullName -Recurse -Force -ErrorAction SilentlyContinue

        # Show deletion log only if the user wants to
        if ($showLog -eq "y") {
            Write-Host "Deleted folder: $($folder.FullName)" -ForegroundColor Cyan
        }
    }
    Write-Host "All node_modules folders have been deleted." -ForegroundColor Green
} elseif ($delete -eq "n") {
    Write-Host "No folders have been deleted. Only the occupied space has been calculated." -ForegroundColor Yellow
} else {
    Write-Host "Invalid option. No folders have been deleted." -ForegroundColor Red
}